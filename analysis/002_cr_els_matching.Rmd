---
title: "Obtain metadata from Crossref Dump"
output: html_notebook
---

```{r, setup, echo=FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = TRUE,
  fig.width = 6,
  fig.asp = 0.618,
  out.width = "70%",
  fig.align = "center",
  dpi = 300
)
options(scipen = 999, digits = 4)
knitr::knit_hooks$set(
  inline = function(x) {
    if (is.numeric(x)) {
      return(prettyNum(x, big.mark = ","))
    } else{
      return(x)
    }
  }
)
```

### Connect to database

```{r}
# connect to google bg where we imported the json lines Unpaywall dump
library(DBI)
library(bigrquery)
con <- dbConnect(
  bigrquery::bigquery(),
  project = "api-project-764811344545",
  dataset = "cr_dump_march_20"
)
```

### Journals associated with Elsevier

Determined by the Crossref member id (78).

```{sql connection=con, output.var="els_2020_jns"}
SELECT DISTINCT(ISSN)
FROM `api-project-764811344545.cr_dump_march_20.cr_08_20_expanded` 
WHERE member = '78' AND issued_year BETWEEN 2015 AND 2019
```

### Comparision with Crossref Dump

Journals from hybrid Elsevier list not indexed in Crossref

```{r}
library(tidyverse)
library(here)
els_jns_df <- readr::read_csv(here::here("data", "elsevier_apc_list.csv"))
els_jns_df %>% 
  filter(!issn %in% els_2020_jns$ISSN, oa_type == "Hybrid")
```

Possible reason:

a) Journal transfer including metadata ownership. Example: Canadian Association of Radiologists Journal (transferred from Elsevier to SAGE Publications as of 2020)

```{sql connection=con}
SELECT member, publisher, COUNT(DISTINCT(doi)) as articles
FROM `api-project-764811344545.cr_dump_march_20.cr_08_20_expanded` 
WHERE container_title = 'Canadian Association of Radiologists Journal'
GROUP BY member, publisher
```

However, there are cases, where metadata ownership was not fully transferred. Example: Acta Mathematica Scientia (transferred to Springer Nature as of 2019)

```{sql connection=con}
SELECT member, publisher, COUNT(DISTINCT(doi)) as articles
FROM `api-project-764811344545.cr_dump_march_20.cr_08_20_expanded` 
WHERE container_title = 'Acta Mathematica Scientia'
GROUP BY member, publisher
```

b) Journal started in 2020
