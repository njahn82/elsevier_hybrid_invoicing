---
title: "invoice analysis"
output: github_document
---

```{r, setup, echo=FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  fig.width = 6,
  fig.asp = 0.618,
  out.width = "70%",
  fig.align = "center",
  dpi = 300
)
options(scipen = 999, digits = 4)
knitr::knit_hooks$set(
  inline = function(x) {
    if (is.numeric(x)) {
      return(formatC(x, big.mark = ",", format = "fg", digits = 2))
    } else{
      return(x)
    }
  }
)
```

```{r}
# libraries
library(tidyverse)
library(here)
library(cowplot)
library(gt)
```


```{r}
# load eligible oa articles
hybrid_volume <- readr::read_csv(here::here("data", "hybrid_volume_eligible.csv"))

# aggregate data
sponsored_articles <- hybrid_volume %>%
  mutate(oa_sponsor_type = ifelse(is.na(oa_sponsor_type), "unknown", oa_sponsor_type)) %>%
  mutate(oa_sponsor_type = recode(oa_sponsor_type, 
                                  `FundingBody` = "Agreement",
                                  `ElsevierWaived` = "Fee Waived")) %>%
  mutate(fct_source = fct_infreq(oa_sponsor_type)) %>%
  mutate(fct_source = fct_lump(fct_source, prop = 0.05)) %>%
  count(issued_year, fct_source)
all_articles <- hybrid_volume %>%
  group_by(issued_year) %>%
  summarise(n = n())
```

In most cases, Elsevier sent invoices for hybrid open access publication fees to individual authors (`r round(hybrid_volume %>% filter(oa_sponsor_type == "Author") %>% nrow() / nrow(hybrid_volume) * 100, 0)`%). For around `r round(hybrid_volume %>% filter(oa_sponsor_type == "FundingBody") %>% nrow() / nrow(hybrid_volume) * 100, 0)`% of articles, the publisher directly billed funders and research organisations. The proportion of open access articles where Elsevier granted publication fee waivers was `r round(hybrid_volume %>% filter(oa_sponsor_type == "ElsevierWaived") %>% nrow() / nrow(hybrid_volume) * 100, 0)`%.

Figure \@ref(fig:invoiceoverview) shows the annual development per invoicing type. Each type is visualised separately as parts of the total. The grey areas show the overall yearly distribution of open access articles in hybrid journals, and the proportion of each invoicing type is highlighted in blue, The figure reveals a general growth of open access articles in hybrid journals. It illustrates that this development was mainly driven by billing individual authors, while central invoicing stagnated. Also, the amount of fee-waived articles remained more or less constant from 2015 to date.

```{r invoiceoverview, fig.cap="Development of fee-based open access publishing in Elsevier hybrid journals by invoicing type. Colored bars represent the invoice recipient, or whether the fee was waived. Grey bars show the total number of hybrid open access articles published in Elsevier journals from 2015 to date."}
# plot
ggplot(sponsored_articles, aes(x = gsub("20", "'", issued_year), y = n)) +
  geom_bar(
    data = all_articles,
    aes(fill = "All hybrid OA"),
    color = "transparent",
    stat = "identity"
  ) +
  geom_bar(aes(fill = "by invoicing type"), color = "transparent", stat = "identity") +
  facet_wrap( ~ fct_source, nrow = 1) +
  scale_fill_manual(values = c("#b3b3b3a0", "#56B4E9"), name = "") +
  labs(x = NULL, y = NULL) + 
  scale_y_continuous(labels = scales::number_format(big.mark = " "),
                      expand = expansion(mult = c(0, 0.05))) + theme_minimal_hgrid() +
  theme(legend.position="top", legend.justification = "right")
```



```{r}
cc_invoice <- hybrid_volume %>%
  mutate(cc_norm = ifelse(grepl("/by/", URL), "cc-by", "cc-by-nc")) %>%
   mutate(oa_sponsor_type = ifelse(is.na(oa_sponsor_type), "unknown", oa_sponsor_type)) %>%
  mutate(oa_sponsor_type = recode(oa_sponsor_type, 
                                  `FundingBody` = "Agreement",
                                  `ElsevierWaived` = "Fee Waived")) %>%
  mutate(fct_source = fct_infreq(oa_sponsor_type)) %>%
  mutate(fct_source = fct_lump(fct_source, prop = 0.05)) %>%
  count(issued_year, fct_source, cc_norm)

cc_invoice_type <- cc_invoice %>% 
  group_by(fct_source, cc_norm) %>% 
  summarise(n = sum(n))
cc_norm_all <- cc_invoice_type %>%
  ungroup() %>%
  group_by(cc_norm) %>%
  summarise(all = sum(n))
cc_type_all <- cc_invoice_type %>%
  ungroup() %>%
  group_by(fct_source) %>%
  summarise(all = sum(n))
license_count <- inner_join(cc_invoice_type, cc_norm_all, by =  "cc_norm") %>% mutate(prop = n / all)
license_summary_count <- inner_join(cc_invoice_type, cc_type_all, by =  "fct_source") %>% mutate(prop = n / all)
```

In terms of re-use, the type of invoicing is strongly related to whether the open content license permits commercial adaption or not (see figure). Although most open access articles published in Elsevier's hybrid journals were billed to authors directly, centrally invoiced articles accounted for the largest share of articles under an CC BY licenses (`r round(filter(license_count, fct_source == "Agreement", cc_norm == "cc-by") %>% pull(prop) * 100, 0)`%). Consequently, `r round(filter(license_summary_count, fct_source == "Agreement", cc_norm == "cc-by") %>% pull(prop) * 100, 0)`% of centrally invoiced articles permits commercial adaption.

```{r}
ggplot(cc_invoice, aes(factor(issued_year), n, fill = fct_source, group = fct_source)) +
  geom_area(stat = "identity",
            color = "white",
            alpha = 0.8,
            position = position_stack(reverse = T)) +
  scale_y_continuous(
    expand = expansion(mult = c(0, 0.05)),
    labels = function(x)
        format(x, big.mark = ",", scientific = FALSE),
      breaks = scales::pretty_breaks()
  ) +
  facet_grid(~cc_norm) +
  scale_fill_brewer(palette = "Set1") +
  labs(x = "Publication year", y = "Total OA articles") +
  theme_minimal_hgrid() +
  theme(legend.position = "top",
        legend.justification = "right") +
  guides(fill = guide_legend("Invoicing"))
```



```{r}
# invoicing analysis
library(googlesheets4)
tt <- read_sheet("https://docs.google.com/spreadsheets/d/1AqjCLn6VNGJpQ6zdmFSwuhFsDBIITSxijA0r0WLJZTQ/", sheet = 2)
```

```{r}
hybrid_invoice <- hybrid_volume %>%
  filter(oa_sponsor_type == "FundingBody") %>%
  rename(yrl_volume = articles) %>%
  left_join(tt, by = c("oa_sponsor_name"))

sponsor_country <- hybrid_invoice %>%
  mutate(Country = ifelse(is.na(Country), "Other", Country)) %>%
  mutate(country_factor = fct_lump(Country, prop = 0.025)) %>%
  group_by(country_factor) %>%
  summarise(n = n_distinct(doi)) %>%
  mutate(prop = n / sum(n))
```

Next, we examined funders and research organisations that were invoiced directly by Elsevier. In total, we were able to identify `r length(unique(hybrid_invoice$oa_sponsor_name))` sponsoring bodies. Figure presents a breakdown by country, highlighting the dominating role of a few countries. Not surprisingly, mostly British funders paid for hybrid open access in Elsevier hybrid journals (`r round(sponsor_country %>% filter(country_factor == "United Kingdom") %>% pull(prop) * 100, 0)`%), followed by funding bodies from the European Commission (`r round(sponsor_country %>% filter(country_factor == "Multinational") %>% pull(prop) * 100, 0)`%) and the Netherlands (`r round(sponsor_country %>% filter(country_factor == "The Netherlands") %>% pull(prop) * 100, 0)`%). In the latter case, invoices for individual open access articles were not send to research funders, but to the Dutch VSNU, a consortium  of Universities in the Netherlands that has negotiated agreements with Elsevier since 2016. The prominent role of Norway can be also explained by a national deal, which started in 2019. US-based open access sponsors originated mainly from the Bill & Melinda Gates Foundation (n = `r hybrid_invoice %>% filter(oa_sponsor_name == "Bill & Melinda Gates Foundation") %>% distinct(doi) %>% nrow()`).

```{r}
sponsor_country %>%
  mutate(country_factor = fct_reorder(country_factor, n)) %>%
  mutate(country_factor = forcats::fct_relevel(country_factor, "Other", after = 0L)
) %>%
  ggplot(aes(country_factor, n)) +
  geom_bar(stat = "identity", fill = "#56B4E9") +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05))) +
  coord_flip() +
  theme_minimal_vgrid() +
  labs(y = "Number of invoiced OA articles", x = NULL)
```

